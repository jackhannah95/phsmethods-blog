---
title: 'phsmethods: an R package for Public Health Scotland'
author: "Jack Hannah"
date: "11 March 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
```


## Background

On Wednesday 1st April 2020, [Public Health Scotland (PHS)](https://www.publichealthscotland.scot/) will come into being. It will be formed as a result of a three-way merger between [NHS Health Scotland](http://www.healthscotland.scot/) and the [Information Services Division (ISD)](https://www.isdscotland.org/) and [Health Protection Scotland (HPS)](https://www.hps.scot.nhs.uk/) sections of [Public Health and Intelligence (PHI)](https://nhsnss.org/how-nss-works/our-structure/public-health-and-intelligence/) (which is in itself a strategic business unit of [NHS National Services Scotland (NSS)](https://nhsnss.org/)). Lots of acronyms, none of which you care about.

The [Transforming Publishing Programme (TPP)](https://www.isdscotland.org/Products-and-Services/Transforming-Publishing-Programme/) was devised three-or-so years ago in an attempt to modernise the way in which ISD produces and presents its statistics. Traditionally, analytical work within ISD has been undertaken using proprietary software such as Excel and SPSS, with output presented predominantly in the form of PDF reports. It requires a great deal of manual formatting, causes an even greater deal of frustration for analysts with programming skills, and results in more copy and paste errors than anyone would care to admit.

Over time, ISD has gradually (and at times begrudgingly) come to embrace open source software - predominantly R and, to a lesser extent, Python. TPP have been at the forefront of much of this: creating [style guides](https://github.com/Health-SocialCare-Scotland/R-Resources/blob/master/PHI%20R%20style%20guide.md); working with producers of official and national statistics to convert [PDF reports](https://www.isdscotland.org/Health-Topics/Mental-Health/Publications/2017-03-14/2017-03-14-Mental-Health-Report.pdf?34582155943) into [Shiny applications](https://www.isdscotland.org/Health-Topics/Mental-Health/Publications/2019-09-10/mental-health-inpatient-activity/data-explorer/); producing [R packages](https://github.com/NHS-NSS-transforming-publications/hsmr) and [Reproducible Analytical Pipelines](https://www.isdscotland.org/About-ISD/Methodologies/_docs/Reproducible_Analytical_Pipelines_paper_v1.4.pdf); and introducing [version control](https://nhs-nss-transforming-publications.github.io/git-guide/), among other things. Now, with the move to Public Health Scotland looming, TPP's purview is broadening; not only to further the adoption of R, but to ensure it's adopted in a consistent manner by the hundreds of analysts PHS will employ.


## Introducing phsmethods

Analysts working across a multitude of teams in the soon-to-be-formed PHS have to perform many of the same, repetitive tasks, not all of which are catered for (to the best of our knowledge) by existing R packages: assigning dates to financial years in YYYY/YY format (e.g. 2016/17); formatting improperly recorded postcodes; returning quarters in plain English (e.g January to March 2020 or Jan-Mar 2020) rather than the slightly restrictive formats offered by [`lubridate::quarter()`](https://lubridate.tidyverse.org/reference/quarter.html) and [`zoo::yearqtr()`](https://cran.r-project.org/web/packages/zoo/zoo.pdf). The list is endless, and every analyst has their own workaround, which quickly becomes a problem. Even if disregarding the time wasted by multiple people devising an alternative way of doing the same thing, how can anyone be sure that everyone's method actually does the same thing?

The [phsmethods](https://github.com/Health-SocialCare-Scotland/phsmethods) package is devised to address (some of) these concerns. At the time of writing, it contains seven functions to automate some of the more laborious tasks analysts regularly face, with more in the works. None deal with any statistical methodology, nor are they likely to provoke any controversy or consternation over their methods of implementation; they are simple functions designed to make simple things that should be simple.

phsmethods isn't on [CRAN](https://cran.r-project.org/), but it comes with many of the features one would expect from a CRAN package: [function documentation](https://github.com/Health-SocialCare-Scotland/phsmethods/tree/master/man); [unit tests](https://github.com/Health-SocialCare-Scotland/phsmethods/tree/master/tests/testthat); [continuous integration](https://travis-ci.com/github/Health-SocialCare-Scotland/phsmethods); [code coverage](https://codecov.io/gh/Health-SocialCare-Scotland/phsmethods); and [releases](https://github.com/Health-SocialCare-Scotland/phsmethods/releases). No hex sticker yet, but maybe one day.


## Using phsmethods

Practical examples featuring all of phsmethods' functions are available in the package's [README](https://github.com/Health-SocialCare-Scotland/phsmethods/blob/master/README.md) and no one will make it to the end of this blog if they're all regurgitated here. But hopefully one is okay. Consider a dataset with a postcode variable that looks like this:

```{r}
x <- tibble::tribble(
  ~patient_id, ~postcode,
  1,           "G26QE",
  2,           "KA8 9NB",
  3,           "PA152TY ",
  4,           "G 4 2 9 B A",
  5,           "g207al",
  6,           "Dg98bS",
  7,           "DD37J    y",
  8,           "618",
  9,           "rabbit",
  10,          "owl"
)

x
```


It's a problem that analysts across the NHS and beyond face regularly: a dataset containing postcodes arrives, but the postcodes are recorded inconsistently. Some have spaces; some don't. Some are all upper case; some are all lower case; some are a combination of both. And some aren't real postcodes. Often this dataset is to be joined with a larger postcode directory file to obtain some other piece of information (such as a [measure of deprivation](https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/)). Joining these datasets tends not to be a trivial task; sometimes a [fuzzyjoin](https://github.com/dgrtwo/fuzzyjoin) may suffice, but often it requires an arduous process of formatting the postcode variable in one dataset (or both datasets) until they look the same, before combining using a [dplyr join](https://dplyr.tidyverse.org/reference/join.html).

In PHS, postcodes generally follow one of two formats: pc7 format (all values have a string length of seven, with zero, one or two spaces before the last three digits as necessary), or pc8 format (all values have one space before the last three digits, regardless of the total number of digits). `phsmethods::postcode()` is designed to format any postcode, regardless of how it was originally recorded, into either of these formats. Consider the earlier dataset:

```{r, warning=FALSE}
x %>%
  dplyr::mutate(postcode = phsmethods::postcode(postcode, format = "pc8"))

x %>%
  
  # The format is pc7 by default
  dplyr::mutate(postcode = phsmethods::postcode(postcode)) %>%
  dplyr::pull(postcode) %>%
  stringr::str_length()
```


In hindsight, maybe it should have been called something other than `postcode()` to avoid the whole `postcode = postcode(postcode)` bit, but [everyone makes mistakes](https://www.tidyverse.org/blog/2018/06/conflicted/) when it comes to naming functions. 

`phsmethods::postcode()` isn't designed to check whether a postcode actually exists; it just checks whether the input provided is a sequence of letters and numbers in the right order and of the right length to theoretically be one and, if so, formats it appropriately. If not, it records it as `NA`. (It records improper postcodes as `NA` to prevent a single erroneous one from causing a large input vector of otherwise valid ones to fail, for presumably the same reason as `lubridate::dmy()` returns an `NA` when provided with `31022020`.) Handily, `phsmethods::postcode()` comes with some warning messages to explain how many values were recorded as NA, why they were recorded as NA, and what happens to lowercase letters:

```{r}
y <- testthat::capture_warnings(x %>% dplyr::mutate(postcode = phsmethods::postcode(postcode)))

writeLines(y[1])
writeLines(y[2])
```


## Next steps